#!/bin/ksh

if [[ $(id -u) -ne 0 ]]; then
	echo "need root privileges"
	exit 1
fi

BROWSER_USER=_debrowser
BROWSER=/usr/local/bin/firefox

getent group $BROWSER_USER || \
	groupadd $BROWSER_USER

getent passwd $BROWSER_USER || \
	useradd -m -L staff -g $BROWSER_USER \
	$BROWSER_USER

# Start Xephyr if it isn't already running
pgrep -q -u "$USER" Xephyr || /usr/X11R6/bin/Xephyr -resizeable :1 &

# Wait for Xephyr to get up and running
sleep 3

cat > /home/${BROWSER_USER}/start.sh << EOF
#!/bin/sh

for font in \$(ls /usr/local/share/fonts/); do
	echo "Adding \${font} to font path"
	DISPLAY=:1 xset +fp /usr/local/share/fonts/\${font}
done
DISPLAY=:1 xset fp rehash

echo "Setting Xmodmap"
DISPLAY=:1 xmodmap ~/.Xmodmap &

ulimit -n \$(ulimit -Hn)
ulimit -d \$(ulimit -Hd)

pgrep -q -u $BROWSER_USER cwm || DISPLAY=:1 cwm &
DISPLAY=:1 exec $BROWSER \$@ &
EOF

chmod +x /home/${BROWSER_USER}/start.sh
chmod g+rw /home/${BROWSER_USER}/start.sh

cat > /home/${BROWSER_USER}/.Xmodmap << EOF
remove mod1 = Alt_L
remove mod4 = Super_L
keycode 64 = Super_L
keycode 115 = Alt_L
EOF

# Run the above script as our BROWSER_USER
su -l -c staff $BROWSER_USER -c "/home/${BROWSER_USER}/start.sh"
