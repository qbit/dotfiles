#!/bin/ksh

. ~/.kshlib

OPTS=" -V "
DST=/tmp/upgrade
CPUS=$( sysctl hw.ncpu | awk -F\= '{print $2}' )
ARCH=$( machine )

if [ "${1}X" -eq "X" ]; then
	VER=$( uname -r | sed -e 's/\.//' )
else
	VER=$( echo $1 | sed -e 's/\.//' ) 
fi

# etc sets will be ignored.. make sure base is last!
set -A sets 'comp' 'game' 'man' 'xbase' 'xfont' 'xserv' 'xshare' 'etc' 'xetc' 'base'

set_snap_path

echo $SNAP_PATH

if [ ! -e $DST ]; then
	mkdir $DST
fi

( 
	cd $DST

	ftp $OPTS ${SNAP_PATH}bsd
	ftp $OPTS ${SNAP_PATH}bsd.mp
	ftp $OPTS ${SNAP_PATH}bsd.rd

	for set in ${sets[@]}; do
		ftp $OPTS ${SNAP_PATH}${set}${VER}.tgz
	done

	ftp $OPTS ${SNAP_PATH}INSTALL.${ARCH}

	sudo cp /bsd /obsd
	sudo cp /bsd.rd /obsd.rd
	sudo cp /sbin/reboot /sbin/oreboot

	if [ "${CPUS}" -eq "1" ]; then
		echo "Using bsd.."
		sudo cp bsd /bsd
	else
		echo "Using bsd.mp.."
		sudo cp bsd.mp /bsd
	fi

	if [ $( sysctl hw.model | cut -d\= -f 2 | awk '{print $1}' ) == "QEMU" ]; then
		echo "Please disable mpbios!"
		sudo config -e -f /bsd
	fi

	sudo cp bsd.rd /bsd.rd

	PV=0
	if [ -x /usr/local/bin/pv ]; then
		PV=1
	fi

	for set in ${sets[@]}; do
		if [ ! -e ${set}${VER}.tgz ]; then
			echo "Perhaps the set revision changed? ( example 5.0 to 5.1)"
			exit 1;
		fi
		if [ "${set}" != "etc" ] && [ "${set}" != "xetc" ]; then
			if [ $PV == 1 ]; then
				sudo -s "pv ${set}${VER}.tgz | tar -C / -xzphf -"
			else 
				sudo tar -C / -vxzphf ${set}${VER}.tgz
			fi
		else 
			cp ${set}${VER}.tgz ~/
		fi
	done

	echo "I put etc.tgz and xetc.tgz in ~/"
	echo "Don't forget to sysmerge when done!" 
)
